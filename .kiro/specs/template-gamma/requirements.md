# 要件定義書

## はじめに

Template Gamma は、Next.js 15.5.2 と React 19.0.0 を使用し、OpenNext で Cloudflare Workers 上に展開される Web アプリケーション開発用のプロジェクトテンプレートです。Supabase（Auth + Postgres + Storage）をバックエンドの中核とし、型安全性を担保するために OpenAPI 定義から API を生成してフロントとバックで共通利用します。

## 要件

### 要件 1: ヘルスチェック機能

**ユーザーストーリー:** システム管理者として、アプリケーションの稼働状況を確認できるヘルスチェック機能が欲しい。これにより、システムの健全性を監視できる。

#### 受け入れ基準

1. WHEN ユーザーが `/health` にアクセスした時 THEN システムは SSR でヘルスチェックページを表示する
2. WHEN ユーザーが `/api/health` にアクセスした時 THEN システムは JSON 形式でヘルスチェック結果を返却する
3. WHEN ヘルスチェックが実行された時 THEN システムは Supabase への接続確認を行う（ON/OFF 可能）
4. WHEN ヘルスチェックが実行された時 THEN システムは `status`、`dependencies`、`version`、`commit`、`buildTime` を含むレスポンスを返却する

### 要件 2: 認証システム

**ユーザーストーリー:** ユーザーとして、安全にログインしてアプリケーションを利用したい。これにより、個人の情報やデータを保護できる。

#### 受け入れ基準

1. WHEN 未認証ユーザーがトップページにアクセスした時 THEN システムはログインボタンを表示する
2. WHEN ユーザーがログインボタンをクリックした時 THEN システムは `/auth/login` にリダイレクトする
3. WHEN ユーザーが `/auth/login` にアクセスした時 THEN システムは Supabase OAuth 認証を開始する
4. WHEN OAuth 認証が完了した時 THEN システムは `/auth/callback` でセッションを発行し `/home` にリダイレクトする
5. WHEN 未認証ユーザーが `/home` にアクセスした時 THEN システムは `/` にリダイレクトする
6. WHEN ユーザーがログアウトを実行した時 THEN システムは `/auth/logout` でセッションを削除する

### 要件 3: ホーム画面機能

**ユーザーストーリー:** 認証済みユーザーとして、ホーム画面でアプリケーションの機能を利用したい。これにより、システムの状態確認や画像管理ができる。

#### 受け入れ基準

1. WHEN 認証済みユーザーが `/home` にアクセスした時 THEN システムはホーム画面を表示する
2. WHEN ホーム画面が表示された時 THEN システムはバックエンド・ヘルスチェック実行ボタンを配置する
3. WHEN ユーザーがヘルスチェックボタンを押下した時 THEN システムは `/api/health` を呼び出し結果を画面に表示する
4. WHEN ヘルスチェック実行中の時 THEN システムは Loading 状態を表示し、再試行制御を提供する

### 要件 4: 画像管理機能

**ユーザーストーリー:** 認証済みユーザーとして、画像をアップロードして管理したい。これにより、個人の画像を安全に保存・閲覧できる。

#### 受け入れ基準

1. WHEN 認証済みユーザーがホーム画面にアクセスした時 THEN システムは画像アップロード UI を提供する
2. WHEN 未認証ユーザーが画像アップロードを試行した時 THEN システムはアップロードを拒否する
3. WHEN 認証済みユーザーがホーム画面にアクセスした時 THEN システムはユーザー自身に紐づく画像の一覧を最新順で表示する
4. WHEN 画像が表示される時 THEN システムは処理状態（uploading/processing/ready/failed）を表示する
5. WHEN 画像の状態が ready の時 THEN システムは画像を表示可能にする
6. WHEN 画像がアップロードされた時 THEN システムは画像をユーザー ID に強固に紐付けて保存する

### 要件 5: API 契約と型安全性

**ユーザーストーリー:** 開発者として、フロントエンドとバックエンド間の API 通信が型安全で一貫性があることを保証したい。これにより、開発効率と品質を向上できる。

#### 受け入れ基準

1. WHEN API が定義される時 THEN システムは OpenAPI 仕様に準拠する
2. WHEN API 契約が更新される時 THEN システムは型とクライアントを自動生成する
3. WHEN フロントエンドが API を呼び出す時 THEN システムは生成されたクライアントを利用する
4. WHEN Route Handlers が実装される時 THEN システムは契約に準拠する
5. WHEN API エラーが発生した時 THEN システムはコード + メッセージ形式で返却する
6. WHEN エラーコードが定義される時 THEN システムは `packages/contracts/error-codes.ts` に一元管理する

### 要件 6: セキュリティとセッション管理

**ユーザーストーリー:** ユーザーとして、個人情報とセッションが安全に管理されることを期待する。これにより、不正アクセスから保護される。

#### 受け入れ基準

1. WHEN セッションが管理される時 THEN システムは Supabase Auth Cookie を利用する
2. WHEN 認証チェックが実行される時 THEN システムは Next.js middleware で実施する
3. WHEN Cookie が設定される時 THEN システムは `HttpOnly, Secure, SameSite=Lax` を適用する
4. WHEN 画像の作成/更新/削除が実行される時 THEN システムは認証済みユーザーのみ許可する
5. WHEN 画像の参照が実行される時 THEN システムはアップロードした本人のみ許可する
6. WHEN ユーザー ID が処理される時 THEN システムは ID スプーフィングを防止する

### 要件 7: ログとモニタリング

**ユーザーストーリー:** システム管理者として、アプリケーションの動作状況を詳細に把握したい。これにより、問題の早期発見と対応ができる。

#### 受け入れ基準

1. WHEN ログが出力される時 THEN システムは Workers Logs 前提の Pino 要件に従う
2. WHEN ログが出力される時 THEN システムは JSON 単行で出力し、`requestId`、`traceId`、`service`、`env`、`version` を必須項目とする
3. WHEN 機微情報がログに含まれる時 THEN システムは redact で自動マスキングする
4. WHEN エラーが発生した時 THEN システムは `logger.error({ err }, 'unhandled error')` 形式で stack を構造化する
5. WHEN 開発環境でログが出力される時 THEN システムは pretty-print を使用する
6. WHEN 本番/CI 環境でログが出力される時 THEN システムは JSONL 出力を使用する

### 要件 8: パフォーマンスと品質

**ユーザーストーリー:** ユーザーとして、レスポンシブで高品質なアプリケーションを利用したい。これにより、快適な操作体験を得られる。

#### 受け入れ基準

1. WHEN `/api/health` が呼び出される時 THEN システムは p95 < 300ms で応答する
2. WHEN ホームのボタンが操作される時 THEN システムは Loading/再試行制御を実装する
3. WHEN 入力検証が実行される時 THEN システムは Zod を利用して型と実行時バリデーションを統一する
4. WHEN UI が表示される時 THEN システムは Tailwind CSS を利用してモダンなデザインを提供する
5. WHEN テストが実行される時 THEN システムは Vitest を使用する
6. WHEN パッケージが管理される時 THEN システムは pnpm を使用する

### 要件 9: 開発環境とツールチェーン

**ユーザーストーリー:** 開発者として、効率的で一貫性のある開発環境を利用したい。これにより、開発生産性と品質を向上できる。

#### 受け入れ基準

1. WHEN ローカル開発が実行される時 THEN システムは `pnpm dev` で wrangler dev + OpenAPI 生成チェックを実行する
2. WHEN コードが変更される時 THEN システムは ESLint + Prettier + import 整形を適用する
3. WHEN コミットが実行される時 THEN システムは lint-staged + pre-commit を実行する
4. WHEN 依存関係が更新される時 THEN システムは Renovate で minor 自動、major は PR を作成する
5. WHEN CI が実行される時 THEN システムは BACKEND_MODE=monolith|service を両方検証する
6. WHEN 改行コードが処理される時 THEN システムは LF に統一する

### 要件 10: ユーザー情報の永続化

**ユーザーストーリー:** 運用者として、ユーザー登録状況や最終ログインを安全に把握したい。PII を保持せずにアクティビティを分析したい。

#### 受け入れ基準

1. WHEN ユーザーが登録された時 THEN システムは DB に以下を永続化する：`id`（外部 IdP/Supabase Auth の一意識別子）、`created_at`（登録日時）、`updated_at`（更新日時）、`last_login_at`（最終ログイン日時）
2. WHEN ユーザーがログインするたび THEN システムは `last_login_at` を現在時刻へ更新する
3. WHEN ユーザー情報が保存される時 THEN システムはメールアドレス等の PII をサービス DB に保存しない（PII は Supabase Auth/外部 IdP に委譲）
4. WHEN ユーザー情報にアクセスする時 THEN システムは RLS により `id = auth.uid()` の本人行のみ参照・更新可能にする
5. WHEN マイグレーションが実行される時 THEN システムは Supabase CLI の SQL を単一の真実とし、CI で `db reset` 適用可能にする

### 要件 11: 画像保存の段階的方針

**ユーザーストーリー:** ユーザーとして、画像を安全に保存・表示したい。将来的により高度な画像処理機能も利用したい。

#### 受け入れ基準

1. WHEN 画像がアップロードされる時 THEN システムは初期実装として Supabase Storage の専用バケットに `userId` 紐付けで保存する
2. WHEN 画像を表示する時 THEN システムは署名付き URL または公開ポリシーで本人のみに可視化する（共有は将来要件）
3. WHEN 画像にアクセスする時 THEN システムは RLS/ポリシーを必須とする
4. WHEN 将来切替が必要な時 THEN システムはストレージアダプタの実装切替のみで Cloudflare Images へ移行可能にする
5. WHEN 将来フェーズで高度な処理が必要な時 THEN システムは変換/Variant 機能を Images 側へ委譲可能にする

### 要件 12: ヘルスチェックの分離

**ユーザーストーリー:** システム管理者として、用途に応じて異なるレベルのヘルスチェックを実行したい。これにより、効率的な監視とトラブルシューティングができる。

#### 受け入れ基準

1. WHEN システムの基本稼働確認が必要な時 THEN システムは `/api/healthz`（liveness）で依存に触れない軽量チェックを提供し、公開可能にする
2. WHEN システムの準備状態確認が必要な時 THEN システムは `/api/readyz`（readiness）で Supabase/Storage への到達確認を提供し、内部監視用とする
3. WHEN システムの詳細診断が必要な時 THEN システムは `/api/diag`（diagnostics）で遅延・キュー滞留・容量など詳細情報を提供し、認証必須とする
4. WHEN いずれのヘルスチェックが実行される時 THEN システムは `status`、`dependencies`、`version`、`commit`、`buildTime` を返却する

### 要件 13: 観測性の最小構成

**ユーザーストーリー:** システム管理者として、重要なイベントを効率的に監視したい。これにより、問題の早期発見と適切な対応ができる。

#### 受け入れ基準

1. WHEN ログが出力される時 THEN システムは Pino で JSONL（本番/CI）・pretty（開発）出力し、`requestId`、`traceId`、`service`、`env`、`version` を必須付与する
2. WHEN 重大イベントが発生した時 THEN システムは Sentry Free に重大イベントのみをサンプリング送信する（5xx、DLQ 到達、認証系の恒常失敗など）
3. WHEN Sentry にデータを送信する時 THEN システムは PII/トークンを送信前にマスクする
4. WHEN トレースコンテキストが処理される時 THEN システムは W3C TraceContext（`traceparent`）を受継ぎ/発行し、将来の OTLP Exporter 追加を阻害しない命名を使用する

### 要件 14: セキュリティと RLS

**ユーザーストーリー:** ユーザーとして、自分のデータが他のユーザーからアクセスされないことを保証されたい。これにより、プライバシーとセキュリティが確保される。

#### 受け入れ基準

1. WHEN 画像またはユーザー行にアクセスする時 THEN システムは RLS を必須とする
2. WHEN 未認証ユーザーがデータにアクセスしようとする時 THEN システムはアクセスを拒否する
3. WHEN 認証済みユーザーがデータにアクセスする時 THEN システムは既定で本人のみ参照可能にする（共有/公開は将来要件）
4. WHEN データの作成・更新・削除が実行される時 THEN システムはユーザー ID に強固に紐付けて処理し、ID スプーフィングを防止する

### 要件 15: CI/CD と Secrets 運用

**ユーザーストーリー:** 開発者として、自動化されたデプロイメントパイプラインと安全な Secrets 管理を利用したい。これにより、効率的で安全な開発・運用ができる。

#### 受け入れ基準

1. WHEN コードをプッシュする時 THEN システムは GitHub Actions による自動ビルドを実行する
2. WHEN デプロイを実行する時 THEN システムは Wrangler により Preview/Production にデプロイする
3. WHEN Secrets を管理する時 THEN システムは Wrangler で安全に管理する
4. WHEN 依存関係を更新する時 THEN システムは Renovate により minor は自動、major は PR で管理する

### 要件 16: 環境固定と再現性

**ユーザーストーリー:** 開発者として、一貫した開発環境を維持したい。これにより、環境差異による問題を防止できる。

#### 受け入れ基準

1. WHEN 開発環境を構築する時 THEN システムは Node 22 を固定で使用する
2. WHEN Wrangler を使用する時 THEN システムは compatibility_date を固定で使用する
3. WHEN ファイルを作成・編集する時 THEN システムは .gitattributes で LF 改行コードを強制する
4. WHEN パッケージを管理する時 THEN システムは pnpm ワークスペース運用を使用する

### 要件 17: 2モード切替と層違反防止

**ユーザーストーリー:** 開発者として、モノリスとサービス分離の両方のアーキテクチャを検証したい。また、適切な層分離を維持したい。これにより、将来の拡張性と保守性を確保できる。

#### 受け入れ基準

1. WHEN CI を実行する時 THEN システムは `BACKEND_MODE=monolith|service` を CI マトリクスで両方検証する
2. WHEN 依存関係をチェックする時 THEN システムは依存方向リンターで `web → bff → core` の一方向依存を強制する
3. WHEN Route Handlers を実装する時 THEN システムは I/O + Zod のみに制限し、ビジネスロジックを禁止する
4. WHEN 外部 I/O を実装する時 THEN システムは adapters に退避する

### 要件 18: OpenAPI 生成ツールの固定

**ユーザーストーリー:** 開発者として、一貫した API 型生成を行いたい。これにより、フロントエンドとバックエンドの型安全性を保証できる。

#### 受け入れ基準

1. WHEN API 型を生成する時 THEN システムは openapi-typescript を使用する
2. WHEN API クライアントを生成する時 THEN システムは orval を使用する
3. WHEN フロントエンドで API を呼び出す時 THEN システムは生成されたクライアントのみを使用する
4. WHEN API 契約を検証する時 THEN システムは @redocly/cli で Lint と差分検出を実行する

### 要件 19: ローカル開発体験

**ユーザーストーリー:** 開発者として、効率的なローカル開発環境を利用したい。これにより、開発生産性を最大化できる。

#### 受け入れ基準

1. WHEN ローカル開発を開始する時 THEN システムは `pnpm dev` で wrangler dev と OpenAPI 生成チェックを同時実行する
2. WHEN ローカル環境変数を管理する時 THEN システムは .dev.vars を使用する
3. WHEN コード変更を行う時 THEN システムはホットリロードで即時反映する
4. WHEN OpenAPI 契約に変更がある時 THEN システムは起動時に生成物のズレを警告または失敗で通知する

### 要件 20: 品質ゲートの強化

**ユーザーストーリー:** 開発者として、コード品質と契約の整合性を自動的に検証したい。これにより、バグの早期発見と品質向上を実現できる。

#### 受け入れ基準

1. WHEN CI を実行する時 THEN システムは OpenAPI の Breaking Change を検知する
2. WHEN CI を実行する時 THEN システムは依存方向リンターで層違反を検出する
3. WHEN CI を実行する時 THEN システムは生成クライアントとの契約テストを実行する
4. WHEN コードをコミットする時 THEN システムは ESLint + Prettier + lint-staged を実行する

### 要件 21: テストと性能の最小スコープ

**ユーザーストーリー:** 開発者として、重要な機能の動作と性能を保証したい。これにより、システムの信頼性を確保できる。

#### 受け入れ基準

1. WHEN E2E テストを実行する時 THEN システムは Top→Login→Home→Logout フローをカバーする
2. WHEN ヘルスチェックをテストする時 THEN システムは /health SSR/JSON の両方をテストする
3. WHEN 入力検証をテストする時 THEN システムは Zod 不正入力を 422 で弾くことを検証する
4. WHEN /api/health を呼び出す時 THEN システムは p95 < 300ms の性能目標を満たす